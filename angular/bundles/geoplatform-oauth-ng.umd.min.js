!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios"),require("rxjs")):"function"==typeof define&&define.amd?define("@geoplatform/oauth-ng",["exports","axios","rxjs"],e):e((t.geoplatform=t.geoplatform||{},t.geoplatform["oauth-ng"]={}),t.axios,t.rxjs)}(this,function(t,o,e){"use strict";function r(e,s,c,a){return new(c=c||Promise)(function(t,n){function o(t){try{i(a.next(t))}catch(e){n(e)}}function r(t){try{i(a["throw"](t))}catch(e){n(e)}}function i(e){e.done?t(e.value):new c(function(t){t(e.value)}).then(o,r)}i((a=a.apply(e,s||[])).next())})}function i(o,r){var i,s,c,t,a={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(c=2&t[0]?s["return"]:t[0]?s["throw"]||((c=s["return"])&&c.call(s),0):s.next)&&!(c=c.call(s,t[1])).done)return c;switch(s=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,s=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(c=0<(c=a.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){a.label=t[1];break}if(6===t[0]&&a.label<c[1]){a.label=c[1],c=t;break}if(c&&a.label<c[2]){a.label=c[2],a.ops.push(t);break}c[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(o,a)}catch(e){t=[6,e],s=0}finally{i=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}o=o&&o.hasOwnProperty("default")?o["default"]:o;var n=(s.prototype.toJSON=function(){return JSON.parse(JSON.stringify(Object.assign({},this)))},s.prototype.clone=function(){return Object.assign({},this)},s.prototype.compare=function(t){return t instanceof s?this.id===t.id:"object"==typeof t&&"undefined"!=typeof t.id&&t.id===this.id},s.prototype.isAuthorized=function(e){return this.groups&&!!this.groups.map(function(t){return t.name}).filter(function(t){return t===e}).length},s);function s(t){this.id=t.sub,this.username=t.username,this.name=t.name,this.email=t.email,this.org=t.orgs[0]&&t.orgs[0].name,this.groups=t.groups,this.roles=t.roles,this.exp=t.exp}function c(e,n){return r(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,o.get(e,{headers:{Authorization:n?"Bearer "+n:""},responseType:"json"})];case 1:return[2,t.sent().data]}})})}var a=(u.prototype.getMessenger=function(){return this.messenger},u.prototype.getFromLocalStorage=function(t){var e=localStorage.getItem(t);try{return e?atob(e):undefined}catch(n){return undefined}},u.prototype.init=function(){return r(this,void 0,void 0,function(){var e,n,o,r;return i(this,function(t){return(e=this).RPMLoaded()&&this.config.loadRPM?((n=document.createElement("script")).onload=function(){e.init()},n.src="https://s3.amazonaws.com/geoplatform-cdn/gp.rpm/"+(this.config.RPMVersion||"stable")+"/js/gp.rpm.browser.js",document.head.appendChild(n),[2]):(o=this.getJWT(),this.getJWTFromUrl()&&(window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")):window.location.search.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")),this.preveiousTokenPresentCheck=!!o,setInterval(function(){e.checkForLocalToken()},this.config.tokenCheckInterval),(r=this.getUserFromJWT(o))&&this.messenger.broadcast("userAuthenticated",r),[2,r])})})},u.prototype.checkForLocalToken=function(){var t=this.getJWT(),e=!!t;e!==this.preveiousTokenPresentCheck&&(e?this.messenger.broadcast("userAuthenticated",this.getUserFromJWT(t)):this.messenger.broadcast("userSignOut")),this.preveiousTokenPresentCheck=e},u.prototype.removeTokenFromUrl=function(){var t=/[\?\&]access_token=.*(\&token_type=Bearer)?/;window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(t,"")):window.location.search.replace(t,"")},u.prototype.createIframe=function(t){var e=document.createElement("iframe");return e.style.display="none",e.src=t,document.body.appendChild(e),e},u.prototype.login=function(t){var e=t?""+window.location.origin+t:this.config.CALLBACK?this.config.CALLBACK:window.location.href;"token"===this.config.AUTH_TYPE?window.location.href=this.config.IDP_BASE_URL+"/auth/authorize?client_id="+this.config.APP_ID+"&response_type="+this.config.AUTH_TYPE+"&redirect_uri="+encodeURIComponent(e||"/login"):this.config.ALLOW_IFRAME_LOGIN?this.messenger.broadcast("auth:requireLogin"):window.location.href=this.config.LOGIN_URL||"/login?redirect_url="+encodeURIComponent(e)},u.prototype.logout=function(){return r(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,c(this.config.APP_BASE_URL+"/revoke",this.getJWT())];case 1:return t.sent(),this.config.LOGOUT_URL&&(window.location.href=this.config.LOGOUT_URL),this.config.FORCE_LOGIN&&this.forceLogin(),[2]}})})},u.prototype.forceLogin=function(){this.login()},u.prototype.getOauthProfile=function(){return r(this,void 0,void 0,function(){var e,n;return i(this,function(t){switch(t.label){case 0:return(e=this.getJWT())?[4,c(this.config.IDP_BASE_URL+"/api/profile",e)]:[3,2];case 1:return n=t.sent(),[3,3];case 2:n=null,t.label=3;case 3:return[2,n]}})})},u.prototype.getUserFromJWT=function(t){var e=this.parseJwt(t);return e?new n(Object.assign({},e,{id:e.sub})):null},u.prototype.getUserSync=function(){var t=this.getJWT();return this.isImplicitJWT(t)&&this.isExpired(t)?null:this.getUserFromJWT(t)},u.prototype.getUser=function(){return r(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,this.check()];case 1:return(e=t.sent())?[2,e]:(this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN&&this.messenger.on("userAuthenticated",function(t,e){return e}),this.config.ALLOW_IFRAME_LOGIN&&!this.config.FORCE_LOGIN?[2,null]:!this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN?[2,null]:this.config.ALLOW_IFRAME_LOGIN||this.config.FORCE_LOGIN?[2]:[2,null])}})})},u.prototype.check=function(){return r(this,void 0,void 0,function(){var e,n,o,r=this;return i(this,function(t){switch(t.label){case 0:return(e=this.getJWT())?[3,2]:[4,this.checkWithClient()];case 1:return n=t.sent(),[2,e&&e.length?this.getUserFromJWT(n):null];case 2:return this.isImplicitJWT(e)?[3,6]:this.isExpired(e)?[4,this.checkWithClient().then(function(t){return t&&r.getUserFromJWT(t)})]:[3,4];case 3:return o=t.sent(),[3,5];case 4:o=this.getUserFromJWT(e),t.label=5;case 5:return[2,o];case 6:return[2,this.isExpired(e)?Promise.reject(null):this.getUserFromJWT(e)]}})})},u.prototype.checkWithClient=function(){return r(this,void 0,void 0,function(){var e=this;return i(this,function(t){return[2,"token"===this.config.AUTH_TYPE?null:o(this.config.APP_BASE_URL+"/checktoken").then(function(){return e.getJWTfromLocalStorage()})]})})},u.prototype.getJWTFromUrl=function(){var t=(window&&window.location&&window.location.hash?window.location.hash:window.location.toString()).match(/access_token=([^\&]*)/);return t&&t[1]},u.prototype.RPMLoaded=function(){return"undefined"!=typeof window.RPMService},u.prototype.getCookieObject=function(){return document.cookie.split(";").map(function(t){return t.trim().split("=")}).reduce(function(t,e){return t[e[0]]=e[1],t},{})},u.prototype.getFromCookie=function(t){var e=this.getCookieObject()[t];try{return e?atob(decodeURIComponent(e)):undefined}catch(n){return undefined}},u.prototype.getJWTfromLocalStorage=function(){return this.getFromCookie("gpoauth-a")},u.prototype.getJWT=function(){var t=this.getJWTFromUrl()||this.getJWTfromLocalStorage();return!t||t&&this.isImplicitJWT(t)&&this.isExpired(t)?null:t},u.prototype.isExpired=function(t){var e=this.parseJwt(t);return!e||(new Date).getTime()/1e3>e.exp},u.prototype.isImplicitJWT=function(t){var e=this.parseJwt(t);return e&&e.implicit},u.prototype.parseJwt=function(t){var e;if(t)try{var n=t.split(".")[1].replace("-","+").replace("_","/");e=JSON.parse(atob(n))}catch(o){}return e},u.prototype.validateJwt=function(t){var e=this.parseJwt(t);return!!(e&&e.exp&&1e3*e.exp>Date.now())},u);function u(t,e){var n=this,o=this;this.config=t,this.messenger=e,addEventListener("message",function(t){"iframe:userAuthenticated"===t.data&&o.init(),"userSignOut"===t.data&&(n.messenger.broadcast("userAuthenticated",null),n.messenger.broadcast("userSignOut"))}),o.init()}var h={AUTH_TYPE:"grant",APP_BASE_URL:"",ALLOW_IFRAME_LOGIN:!0,FORCE_LOGIN:!1,ALLOW_DEV_EDITS:!1},p=(f.prototype.raw=function(){return this.sub},f.prototype.broadcast=function(t,e){this.sub.next({name:t,user:e})},f.prototype.on=function(e,n){this.sub.filter(function(t){return t.name===e}).subscribe(function(t){return n(new Event(t.name),t.user)})},f);function f(){this.sub=new e.Subject}t.ngGpoauthFactory=function l(t){return new a(Object.assign({},h,t),new p)},t.AuthService=a,t.GeoPlatformUser=n,t.ɵd=p,t.ɵa=h,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=geoplatform-oauth-ng.umd.min.js.map