!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios"),require("rxjs"),require("@angular/core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("ng-gpoauth",["exports","axios","rxjs","@angular/core","@angular/common/http"],e):e(t["ng-gpoauth"]={},t.axios,t.rxjs,t.ng.core,t.ng.common.http)}(this,function(t,n,e,o,s){"use strict";n=n&&n.hasOwnProperty("default")?n["default"]:n;var r=function(){function e(t){this.id=t.sub,this.username=t.username,this.name=t.name,this.email=t.email,this.org=t.orgs[0]&&t.orgs[0].name,this.groups=t.groups,this.roles=t.roles,this.exp=t.exp}return e.prototype.toJSON=function(){return JSON.parse(JSON.stringify(Object.assign({},this)))},e.prototype.clone=function(){return Object.assign({},this)},e.prototype.compare=function(t){return t instanceof e?this.id===t.id:"object"==typeof t&&("undefined"!=typeof t.id&&t.id===this.id)},e.prototype.isAuthorized=function(e){return this.groups&&!!this.groups.map(function(t){return t.name}).filter(function(t){return t===e}).length},e}();function i(t,e){return n.get(t,{headers:{Authorization:e?"Bearer "+e:""},responseType:"json"}).then(function(t){return t.data})}var c=function(){function t(t,e){var n=this;this.config=t,this.messenger=e,addEventListener("message",function(t){"iframe:userAuthenticated"===t.data&&n.init(),"userSignOut"===t.data&&n.removeAuth()});var o=n.init();this.config.ALLOW_SSO_LOGIN&&!o&&"grant"===this.config.AUTH_TYPE&&n.ssoCheck()}return t.prototype.getMessenger=function(){return this.messenger},t.prototype.saveToLocalStorage=function(t,e){localStorage.setItem(t,btoa(e))},t.prototype.getFromLocalStorage=function(t){var e=localStorage.getItem(t);try{return e?atob(e):undefined}catch(n){return undefined}},t.prototype.ssoCheck=function(){var e=this,n=this,t=this.config.APP_BASE_URL+"/login?sso=true&cachebuster="+(new Date).getTime(),o=this.createIframe(t);addEventListener("message",function(t){"iframe:ssoFailed"===t.data&&(o&&o.remove&&o.remove(),e.config.FORCE_LOGIN&&n.forceLogin()),"iframe:userAuthenticated"===t.data&&o&&o.remove&&o.remove()})},t.prototype.init=function(){var t=this.getJWT();return t&&this.setAuth(t),this.getJWTFromUrl()&&(window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")):window.location.search.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")),this.getUserFromJWT(t)},t.prototype.createIframe=function(t){var e=document.createElement("iframe");return e.style.display="none",e.src=t,document.body.appendChild(e),e},t.prototype.login=function(){"token"===this.config.AUTH_TYPE?window.location.href=this.config.IDP_BASE_URL+"/auth/authorize?client_id="+this.config.APP_ID+"&response_type="+this.config.AUTH_TYPE+"&redirect_uri="+encodeURIComponent(this.config.CALLBACK||"/login"):this.config.ALLOW_IFRAME_LOGIN?this.messenger.broadcast("auth:requireLogin"):window.location.href=this.config.LOGIN_URL||"/login?redirect_url="+encodeURIComponent(window.location.href)},t.prototype.logout=function(){var n=this,o=this;return o.removeAuth(),new Promise(function(t,e){i(n.config.APP_BASE_URL+"/revoke?sso=true",n.getJWT()).then(function(){n.config.LOGOUT_URL&&(window.location.href=n.config.LOGOUT_URL),n.config.FORCE_LOGIN&&o.forceLogin(),t()})["catch"](function(t){console.log("Error logging out: ",t),e(t)})})},t.prototype.forceLogin=function(){this.login()},t.prototype.getOauthProfile=function(){var t=this,o=this.getJWT();return new Promise(function(e,n){o?i(t.config.IDP_BASE_URL+"/api/profile",o).then(function(t){return e(t)})["catch"](function(t){return n(t)}):n(null)})},t.prototype.getUserFromJWT=function(t){var e=this.parseJwt(t);return e?new r(Object.assign({},e,{id:e.sub})):null},t.prototype.getUserSync=function(e){var t=this.getJWT();if(!e||"function"!=typeof e)return this.isImplicitJWT(t)&&this.isExpired(t)?null:this.getUserFromJWT(t);this.check().then(function(t){return e(t)})},t.prototype.getUser=function(){var e=this,o=this;return new Promise(function(n,t){e.check().then(function(t){t?n(t):(e.config.ALLOW_IFRAME_LOGIN&&e.config.FORCE_LOGIN&&e.messenger.on("userAuthenticated",function(t,e){n(e)}),e.config.ALLOW_IFRAME_LOGIN&&!e.config.FORCE_LOGIN&&n(null),!e.config.ALLOW_IFRAME_LOGIN&&e.config.FORCE_LOGIN&&(addEventListener("message",function(t){"iframe:ssoFailed"===t.data&&n(o.getUser())}),n(null)),e.config.ALLOW_IFRAME_LOGIN||e.config.FORCE_LOGIN||n(null))})["catch"](function(t){return console.log(t)})})},t.prototype.check=function(){var o=this;return new Promise(function(t,e){var n=o.getJWT();return n?n?o.isImplicitJWT(n)?o.isExpired(n)?Promise.reject(null):t(o.getUserFromJWT(n)):o.isExpired(n)?o.checkWithClient(n).then(function(t){return o.getUserFromJWT(t)}):t(o.getUserFromJWT(n)):t(null):o.checkWithClient("").then(function(t){return t.length?o.getUserFromJWT(t):null})})},t.prototype.checkWithClient=function(r){var i=this;return new Promise(function(o,e){"token"===i.config.AUTH_TYPE?o(null):n(i.config.APP_BASE_URL+"/checktoken",{headers:{Authorization:r?"Bearer "+r:"","Access-Control-Expose-Headers":"Authorization, WWW-Authorization, content-length"}}).then(function(t){var e=t.headers.authorization,n=e&&e.replace("Bearer ","");n&&i.setAuth(n),o(n||r)})["catch"](function(t){return e(t)})})},t.prototype.getJWTFromUrl=function(){var t=(window&&window.location&&window.location.hash?window.location.hash:window.location.toString()).match(/access_token=([^\&]*)/);return t&&t[1]},t.prototype.getJWTfromLocalStorage=function(){return this.getFromLocalStorage("gpoauthJWT")},t.prototype.getJWT=function(){var t=this.getJWTFromUrl()||this.getJWTfromLocalStorage();return!t||t&&this.isImplicitJWT(t)&&this.isExpired(t)?null:t},t.prototype.clearLocalStorageJWT=function(){localStorage.removeItem("gpoauthJWT")},t.prototype.isExpired=function(t){var e=this.parseJwt(t);return!e||(new Date).getTime()/1e3>e.exp},t.prototype.isImplicitJWT=function(t){var e=this.parseJwt(t);return e&&e.implicit},t.prototype.parseJwt=function(t){var e;if(t)try{var n=t.split(".")[1].replace("-","+").replace("_","/");e=JSON.parse(atob(n))}catch(o){}return e},t.prototype.validateJwt=function(t){var e=this.parseJwt(t);return!!(e&&e.exp&&1e3*e.exp>Date.now())},t.prototype.setAuth=function(t){this.saveToLocalStorage("gpoauthJWT",t),this.messenger.broadcast("userAuthenticated",this.getUserFromJWT(t))},t.prototype.removeAuth=function(){localStorage.removeItem("gpoauthJWT"),this.messenger.broadcast("userAuthenticated",null),this.messenger.broadcast("userSignOut")},t}(),a={AUTH_TYPE:"grant",APP_BASE_URL:"",ALLOW_IFRAME_LOGIN:!0,FORCE_LOGIN:!1,ALLOW_DEV_EDITS:!1,ALLOW_SSO_LOGIN:!0},u=function(){function t(t){this.authService=t}return t.prototype.intercept=function(t,e){var n,o=this.authService.getJWT();o?n=t.clone({setHeaders:{Authorization:"Bearer "+o}}):n=t;return e.handle(n)["do"](function r(t){if(t instanceof s.HttpResponse){var e=this.authService.getJWTFromUrl(),n=t.headers.get("Authorization").replace("Bearer","").trim(),o=e||n;o&&this.authService.setAuth(o)}},function i(t){t instanceof s.HttpErrorResponse&&t.status})},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:c}]},t}(),h=function(){function t(){this.sub=new e.Subject}return t.prototype.raw=function(){return this.sub},t.prototype.broadcast=function(t,e){this.sub.next({name:t,user:e})},t.prototype.on=function(e,n){this.sub.filter(function(t){return t.name===e}).subscribe(function(t){return n(new Event(t.name),t.user)})},t}();t.ngGpoauthFactory=function f(t){return new c(Object.assign({},a,t),new h)},t.AuthService=c,t.GeoPlatformUser=r,t.TokenInterceptor=u,t.ɵd=h,t.ɵa=a,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ng-gpoauth.umd.min.js.map