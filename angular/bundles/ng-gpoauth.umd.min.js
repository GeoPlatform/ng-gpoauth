!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios"),require("rxjs"),require("@angular/core")):"function"==typeof define&&define.amd?define("ng-gpoauth",["exports","axios","rxjs","@angular/core"],e):e(t["ng-gpoauth"]={},t.axios,t.rxjs,t.ng.core)}(this,function(t,i,e,n){"use strict";function r(e,s,c,a){return new(c||(c=Promise))(function(t,n){function r(t){try{i(a.next(t))}catch(e){n(e)}}function o(t){try{i(a["throw"](t))}catch(e){n(e)}}function i(e){e.done?t(e.value):new c(function(t){t(e.value)}).then(r,o)}i((a=a.apply(e,s||[])).next())})}function s(r,o){var i,s,c,t,a={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(c=2&t[0]?s["return"]:t[0]?s["throw"]||((c=s["return"])&&c.call(s),0):s.next)&&!(c=c.call(s,t[1])).done)return c;switch(s=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,s=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(c=0<(c=a.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){a.label=t[1];break}if(6===t[0]&&a.label<c[1]){a.label=c[1],c=t;break}if(c&&a.label<c[2]){a.label=c[2],a.ops.push(t);break}c[2]&&a.ops.pop(),a.trys.pop();continue}t=o.call(r,a)}catch(e){t=[6,e],s=0}finally{i=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}i=i&&i.hasOwnProperty("default")?i["default"]:i;var o=function(){function e(t){this.id=t.sub,this.username=t.username,this.name=t.name,this.email=t.email,this.org=t.orgs[0]&&t.orgs[0].name,this.groups=t.groups,this.roles=t.roles,this.exp=t.exp}return e.prototype.toJSON=function(){return JSON.parse(JSON.stringify(Object.assign({},this)))},e.prototype.clone=function(){return Object.assign({},this)},e.prototype.compare=function(t){return t instanceof e?this.id===t.id:"object"==typeof t&&("undefined"!=typeof t.id&&t.id===this.id)},e.prototype.isAuthorized=function(e){return this.groups&&!!this.groups.map(function(t){return t.name}).filter(function(t){return t===e}).length},e}(),c="gpoauthJWT";function a(e,n){return r(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return[4,i.get(e,{headers:{Authorization:n?"Bearer "+n:""},responseType:"json"})];case 1:return[2,t.sent().data]}})})}var u=function(){function t(t,e){var n=this,r=this;this.config=t,this.messenger=e,addEventListener("message",function(t){"iframe:userAuthenticated"===t.data&&r.init(),"userSignOut"===t.data&&r.removeAuth()}),r.init().then(function(t){n.config.ALLOW_SSO_LOGIN&&!t&&"grant"===n.config.AUTH_TYPE&&r.ssoCheck()})}return t.prototype.getMessenger=function(){return this.messenger},t.prototype.saveToLocalStorage=function(t,e){localStorage.setItem(t,btoa(e))},t.prototype.getFromLocalStorage=function(t){var e=localStorage.getItem(t);try{return e?atob(e):undefined}catch(n){return undefined}},t.prototype.ssoCheck=function(){var e=this,n=this,t=this.config.APP_BASE_URL+"/login?sso=true&cachebuster="+(new Date).getTime(),r=this.createIframe(t);addEventListener("message",function(t){"iframe:ssoFailed"===t.data&&(r&&r.remove&&r.remove(),e.config.FORCE_LOGIN&&n.forceLogin()),"iframe:userAuthenticated"===t.data&&r&&r.remove&&r.remove()})},t.prototype.init=function(){return r(this,void 0,void 0,function(){var e;return s(this,function(t){switch(t.label){case 0:return e=this.getJWT(),this.getJWTFromUrl()&&this.removeTokenFromUrl(),e?(this.setAuth(e),[2,this.getUserFromJWT(e)]):[3,1];case 1:return[4,this.getUser()];case 2:return[2,t.sent()]}})})},t.prototype.removeTokenFromUrl=function(){var t=/[\?\&]access_token=.*(\&token_type=Bearer)?/;window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(t,"")):window.location.search.replace(t,"")},t.prototype.createIframe=function(t){var e=document.createElement("iframe");return e.style.display="none",e.src=t,document.body.appendChild(e),e},t.prototype.login=function(t){var e=t?""+window.location.origin+t:this.config.CALLBACK?this.config.CALLBACK:window.location.href;"token"===this.config.AUTH_TYPE?window.location.href=this.config.IDP_BASE_URL+"/auth/authorize?client_id="+this.config.APP_ID+"&response_type="+this.config.AUTH_TYPE+"&redirect_uri="+encodeURIComponent(e||"/login"):this.config.ALLOW_IFRAME_LOGIN?this.messenger.broadcast("auth:requireLogin"):window.location.href=this.config.LOGIN_URL||"/login?redirect_url="+encodeURIComponent(e)},t.prototype.logout=function(){return r(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return this.config.IDP_BASE_URL&&this.createIframe(this.config.IDP_BASE_URL+"/auth/logout"),[4,a(this.config.APP_BASE_URL+"/revoke?sso=true",this.getJWT())];case 1:return t.sent(),this.removeAuth(),this.config.LOGOUT_URL&&(window.location.href=this.config.LOGOUT_URL),this.config.FORCE_LOGIN&&this.forceLogin(),[2]}})})},t.prototype.forceLogin=function(){this.login()},t.prototype.getOauthProfile=function(){return r(this,void 0,void 0,function(){var e,n;return s(this,function(t){switch(t.label){case 0:return(e=this.getJWT())?[4,a(this.config.IDP_BASE_URL+"/api/profile",e)]:[3,2];case 1:return n=t.sent(),[3,3];case 2:n=null,t.label=3;case 3:return[2,n]}})})},t.prototype.getUserFromJWT=function(t){var e=this.parseJwt(t);return e?new o(Object.assign({},e,{id:e.sub})):null},t.prototype.getUserSync=function(t){var e=this.getJWT();return this.isImplicitJWT(e)&&this.isExpired(e)?null:this.getUserFromJWT(e)},t.prototype.getUser=function(){return r(this,void 0,void 0,function(){var e,n=this;return s(this,function(t){switch(t.label){case 0:return[4,this.check()];case 1:return(e=t.sent())?[2,e]:(this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN&&this.messenger.on("userAuthenticated",function(t,e){return e}),this.config.ALLOW_IFRAME_LOGIN&&!this.config.FORCE_LOGIN?[2,null]:!this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN?(addEventListener("message",function(t){if("iframe:ssoFailed"===t.data)return n.getUser()}),[2,null]):this.config.ALLOW_IFRAME_LOGIN||this.config.FORCE_LOGIN?[2]:[2,null])}})})},t.prototype.check=function(){return r(this,void 0,void 0,function(){var e,n,r,o=this;return s(this,function(t){switch(t.label){case 0:return(e=this.getJWT())?[3,2]:[4,this.checkWithClient("")];case 1:return n=t.sent(),[2,e&&e.length?this.getUserFromJWT(n):null];case 2:return this.isImplicitJWT(e)?[3,6]:this.isExpired(e)?[4,this.checkWithClient(e).then(function(t){return o.getUserFromJWT(t)})]:[3,4];case 3:return r=t.sent(),[3,5];case 4:r=this.getUserFromJWT(e),t.label=5;case 5:return[2,r];case 6:return[2,this.isExpired(e)?Promise.reject(null):this.getUserFromJWT(e)]}})})},t.prototype.checkWithClient=function(o){return r(this,void 0,void 0,function(){var e,n,r;return s(this,function(t){switch(t.label){case 0:return"token"!==this.config.AUTH_TYPE?[3,1]:[2,null];case 1:return[4,i(this.config.APP_BASE_URL+"/checktoken",{headers:{Authorization:o?"Bearer "+o:""}})];case 2:return e=t.sent(),n=e.headers.authorization,r=n&&n.replace("Bearer","").trim(),n&&r.length&&this.setAuth(r),[2,r||o]}})})},t.prototype.getJWTFromUrl=function(){var t=(window&&window.location&&window.location.hash?window.location.hash:window.location.toString()).match(/access_token=([^\&]*)/);return t&&t[1]},t.prototype.getJWTfromLocalStorage=function(){return this.getFromLocalStorage(c)},t.prototype.getJWT=function(){var t=this.getJWTFromUrl()||this.getJWTfromLocalStorage();return!t||t&&this.isImplicitJWT(t)&&this.isExpired(t)?null:t},t.prototype.clearLocalStorageJWT=function(){localStorage.removeItem(c)},t.prototype.isExpired=function(t){var e=this.parseJwt(t);return!e||(new Date).getTime()/1e3>e.exp},t.prototype.isImplicitJWT=function(t){var e=this.parseJwt(t);return e&&e.implicit},t.prototype.parseJwt=function(t){var e;if(t)try{var n=t.split(".")[1].replace("-","+").replace("_","/");e=JSON.parse(atob(n))}catch(r){}return e},t.prototype.validateJwt=function(t){var e=this.parseJwt(t);return!!(e&&e.exp&&1e3*e.exp>Date.now())},t.prototype.setAuth=function(t){"<REVOKED>"==t?this.logout():(this.saveToLocalStorage(c,t),this.messenger.broadcast("userAuthenticated",this.getUserFromJWT(t)))},t.prototype.removeAuth=function(){localStorage.removeItem(c),this.messenger.broadcast("userAuthenticated",null),this.messenger.broadcast("userSignOut")},t}(),h={AUTH_TYPE:"grant",APP_BASE_URL:"",ALLOW_IFRAME_LOGIN:!0,FORCE_LOGIN:!1,ALLOW_DEV_EDITS:!1,ALLOW_SSO_LOGIN:!0};var f=function(){function t(t){this.authService=t}return t.prototype.intercept=function(t,e){var s=this,n=s.authService.getJWT();n&&(t=t.clone({setHeaders:{Authorization:"Bearer "+n}}));var r=e.handle(t);return r.subscribe(function c(t){if(function i(t){return t&&t.body}(t)){var e=t.headers.get("Authorization")||"",n=s.authService.getJWTFromUrl(),r=e.replace("Bearer","").trim(),o=(n&&n.length?n:null)||(r&&r.length?r:null);o&&s.authService.setAuth(o)}return t},function o(t){(function e(t){return t&&t.error})(event)&&401===t.status&&s.authService.logout()}),r},t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:u}]},t}(),l=function(){function t(){this.sub=new e.Subject}return t.prototype.raw=function(){return this.sub},t.prototype.broadcast=function(t,e){this.sub.next({name:t,user:e})},t.prototype.on=function(e,n){this.sub.filter(function(t){return t.name===e}).subscribe(function(t){return n(new Event(t.name),t.user)})},t}();t.ngGpoauthFactory=function p(t){return new u(Object.assign({},h,t),new l)},t.AuthService=u,t.GeoPlatformUser=o,t.TokenInterceptor=f,t.ɵd=l,t.ɵa=h,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ng-gpoauth.umd.min.js.map