!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios")):"function"==typeof define&&define.amd?define("@geoplatform/oauth-ng",["exports","axios"],e):e(((t=t||self).geoplatform=t.geoplatform||{},t.geoplatform["oauth-ng"]={}),t.axios)}(this,(function(t,e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;function n(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{a(o.next(t))}catch(t){i(t)}}function c(t){try{a(o.throw(t))}catch(t){i(t)}}function a(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,c)}a((o=o.apply(t,e||[])).next())}))}function o(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var r=function(){function t(t){this.id=t.sub,this.username=t.username,this.name=t.name,this.email=t.email,this.org=t.orgs[0]&&t.orgs[0].name,this.groups=t.groups,this.roles=t.roles,this.exp=t.exp}return t.prototype.toJSON=function(){return JSON.parse(JSON.stringify(Object.assign({},this)))},t.prototype.clone=function(){return Object.assign({},this)},t.prototype.compare=function(e){return e instanceof t?this.id===e.id:"object"==typeof e&&(void 0!==e.id&&e.id===this.id)},t.prototype.isAuthorized=function(t){return this.groups&&!!this.groups.map((function(t){return t.name})).filter((function(e){return e===t})).length},t}();function i(t,r){return n(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,e.get(t,{headers:{Authorization:r?"Bearer "+r:""},responseType:"json"})];case 1:return[2,n.sent().data];case 2:return[2,{error:"Error fetching data",msg:n.sent(),url:t}];case 3:return[2]}}))}))}var s=function(){function t(t,e){var n=this,o=this;this.config=t,this.messenger=e,addEventListener("message",(function(t){"iframe:userAuthenticated"===t.data&&o.init(),"userSignOut"===t.data&&(n.messenger.broadcast("userAuthenticated",null),n.messenger.broadcast("userSignOut"))})),o.init()}return t.prototype.getMessenger=function(){return this.messenger},t.prototype.getFromLocalStorage=function(t){var e=localStorage.getItem(t);try{return e?atob(e):void 0}catch(t){return}},t.prototype.init=function(){return n(this,void 0,void 0,(function(){var t,e,n,r;return o(this,(function(o){return t=this,this.RPMLoaded()&&this.config.loadRPM?((e=document.createElement("script")).onload=function(){t.init()},e.src="https://s3.amazonaws.com/geoplatform-cdn/gp.rpm/"+(this.config.RPMVersion||"stable")+"/js/gp.rpm.browser.js",document.head.appendChild(e),[2]):(n=this.getJWT(),this.getJWTFromUrl()&&(window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")):window.location.search.replace(/[\?\&]access_token=.*\&token_type=Bearer/,"")),this.preveiousTokenPresentCheck=!!n,setInterval((function(){t.checkForLocalToken()}),this.config.tokenCheckInterval),(r=this.getUserFromJWT(n))&&this.messenger.broadcast("userAuthenticated",r),[2,r])}))}))},t.prototype.checkForLocalToken=function(){var t=this.getJWT(),e=!!t;e!==this.preveiousTokenPresentCheck&&(e?this.messenger.broadcast("userAuthenticated",this.getUserFromJWT(t)):this.messenger.broadcast("userSignOut")),this.preveiousTokenPresentCheck=e},t.prototype.removeTokenFromUrl=function(){var t=/[\?\&]access_token=.*(\&token_type=Bearer)?/;window.history&&window.history.replaceState?window.history.replaceState({},"Remove token from URL",window.location.href.replace(t,"")):window.location.search.replace(t,"")},t.prototype.createIframe=function(t){var e=document.createElement("iframe");return e.style.display="none",e.src=t,document.body.appendChild(e),e},t.prototype.login=function(t){var e=t?""+window.location.origin+t:this.config.CALLBACK?this.config.CALLBACK:window.location.href;"token"===this.config.AUTH_TYPE?window.location.href=this.config.IDP_BASE_URL+"/auth/authorize?client_id="+this.config.APP_ID+"&response_type="+this.config.AUTH_TYPE+"&redirect_uri="+encodeURIComponent(e||"/login"):this.config.ALLOW_IFRAME_LOGIN?this.messenger.broadcast("auth:requireLogin"):window.location.href=this.config.LOGIN_URL||"/login?redirect_url="+encodeURIComponent(e)},t.prototype.logout=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,i(this.config.APP_BASE_URL+"/revoke",this.getJWT())];case 1:return e.sent(),[3,3];case 2:return t=e.sent(),console.log("Error logging out: "+t),[3,3];case 3:return this.config.LOGOUT_URL&&(window.location.href=this.config.LOGOUT_URL),this.config.FORCE_LOGIN&&this.forceLogin(),[2]}}))}))},t.prototype.forceLogin=function(){this.login()},t.prototype.getOauthProfile=function(){return n(this,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:return(t=this.getJWT())?[4,i(this.config.IDP_BASE_URL+"/api/profile",t)]:[3,2];case 1:return e=n.sent(),[3,3];case 2:e=null,n.label=3;case 3:return[2,e]}}))}))},t.prototype.getUserFromJWT=function(t){var e=this.parseJwt(t);return e?new r(Object.assign({},e,{id:e.sub})):null},t.prototype.getUserSync=function(){var t=this.getJWT();return this.isImplicitJWT(t)&&this.isExpired(t)?null:this.getUserFromJWT(t)},t.prototype.getUser=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,this.check()];case 1:return(t=e.sent())?[2,t]:(this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN&&this.messenger.on("userAuthenticated",(function(t,e){return e})),this.config.ALLOW_IFRAME_LOGIN&&!this.config.FORCE_LOGIN?[2,null]:!this.config.ALLOW_IFRAME_LOGIN&&this.config.FORCE_LOGIN?[2,null]:this.config.ALLOW_IFRAME_LOGIN||this.config.FORCE_LOGIN?[2]:[2,null])}}))}))},t.prototype.check=function(){return n(this,void 0,void 0,(function(){var t,e,n,r=this;return o(this,(function(o){switch(o.label){case 0:return(t=this.getJWT())?[3,2]:[4,this.checkWithClient()];case 1:return e=o.sent(),[2,t&&t.length?this.getUserFromJWT(e):null];case 2:return this.isImplicitJWT(t)?[3,6]:this.isExpired(t)?[4,this.checkWithClient().then((function(t){return t&&r.getUserFromJWT(t)}))]:[3,4];case 3:return n=o.sent(),[3,5];case 4:n=this.getUserFromJWT(t),o.label=5;case 5:return[2,n];case 6:return[2,this.isExpired(t)?Promise.reject(null):this.getUserFromJWT(t)]}}))}))},t.prototype.checkWithClient=function(){return n(this,void 0,void 0,(function(){var t=this;return o(this,(function(n){return[2,"token"===this.config.AUTH_TYPE?null:e(this.config.APP_BASE_URL+"/checktoken").then((function(){return t.getJWTfromLocalStorage()}))]}))}))},t.prototype.getJWTFromUrl=function(){var t=(window&&window.location&&window.location.hash?window.location.hash:window.location.toString()).match(/access_token=([^\&]*)/);return t&&t[1]},t.prototype.RPMLoaded=function(){return void 0!==window.RPMService},t.prototype.getCookieObject=function(){return document.cookie.split(";").map((function(t){return t.trim().split("=")})).reduce((function(t,e){return t[e[0]]=e[1],t}),{})},t.prototype.getFromCookie=function(t){var e=this.getCookieObject()[t];try{return e?atob(decodeURIComponent(e)):void 0}catch(t){return}},t.prototype.getJWTfromLocalStorage=function(){return this.getFromCookie("gpoauth-a")},t.prototype.getJWT=function(){var t=this.getJWTFromUrl()||this.getJWTfromLocalStorage();return!t||t&&this.isImplicitJWT(t)&&this.isExpired(t)?null:t},t.prototype.isExpired=function(t){var e=this.parseJwt(t);return!e||(new Date).getTime()/1e3>e.exp},t.prototype.isImplicitJWT=function(t){var e=this.parseJwt(t);return e&&e.implicit},t.prototype.parseJwt=function(t){var e;if(t)try{var n=t.split(".")[1].replace("-","+").replace("_","/");e=JSON.parse(atob(n))}catch(t){}return e},t.prototype.validateJwt=function(t){var e=this.parseJwt(t);return!!(e&&e.exp&&1e3*e.exp>Date.now())},t}();t.AuthService=s,t.DefaultAuthConf={AUTH_TYPE:"grant",APP_BASE_URL:"",ALLOW_IFRAME_LOGIN:!0,FORCE_LOGIN:!1,ALLOW_DEV_EDITS:!1},t.GeoPlatformUser=r,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=geoplatform-oauth-ng.umd.min.js.map